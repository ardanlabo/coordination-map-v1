<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Coordination Dashboard – Benishangul-Gumuz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS (minimap only) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #app { position:relative; height:100%; background:#f6f7f9; }

    #header {
      padding:14px 16px;
      background:#ffffff;
      border-bottom:1px solid #e9e9e9;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    #header h1 { margin:0; font-size:16px; font-weight:800; }
    #header .actions { display:flex; gap:8px; align-items:center; }

    .btn {
      padding:8px 10px;
      border:1px solid #ddd;
      background:#fff;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn:hover { background:#f3f3f3; }

    #content {
      height: calc(100% - 54px);
      padding:16px;
      box-sizing:border-box;
    }

    /* Minimap */
    #minimap-wrap{
      position:absolute;
      top:70px;
      right:16px;
      width: 20vw;
      min-width: 260px;
      max-width: 360px;
      height: 220px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
      overflow:hidden;
      z-index:10;
      cursor:pointer;
    }
    #minimap { width:100%; height:100%; }
    #minimap-badge{
      position:absolute;
      left:10px;
      top:10px;
      background:rgba(255,255,255,0.92);
      border:1px solid #e6e6e6;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight:800;
      z-index:11;
    }

    /* Layout cards */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:16px;
      max-width: 1200px;
    }
    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      padding:14px;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    .card h2{ margin:0 0 10px 0; font-size:14px; font-weight:900; }
    .muted{ color:#666; font-size:13px; line-height:1.4; }

    /* Timeline container */
    #timeline{
      max-height: 520px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:10px;
      background:#fff;
    }
    .month-header{
      padding:10px 12px;
      background:#f7f7f7;
      border-bottom:1px solid #eee;
      font-weight:900;
    }
    .t-item{
      padding:10px 12px;
      border-bottom:1px solid #f0f0f0;
    }
    .t-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .t-org{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .t-sub{
      color:#666;
      margin-top:2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Status filter row */
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin:10px 0 10px 0;
      padding:8px 10px;
      border:1px solid #eee;
      border-radius:10px;
      background:#fafafa;
      font-size:13px;
    }
    .filter-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff;
      border:1px solid #e9e9e9;
      border-radius:999px;
      padding:4px 10px;
      user-select:none;
      cursor:pointer;
    }
    .filter-chip input{ transform: translateY(1px); }
    .filter-spacer{ flex:1; }
    #timeline-count{
      color:#555;
      font-weight:800;
      white-space:nowrap;
    }
  </style>
</head>
<body>

<div id="app">
  <div id="header">
    <h1>Coordination Dashboard — Benishangul-Gumuz</h1>
    <div class="actions">
      <button class="btn" id="btn-open-map" type="button">Open full map</button>
      <button class="btn" id="btn-update" type="button" title="Coming soon">Update data (coming soon)</button>
    </div>
  </div>

  <div id="content">
    <div class="grid">
      <!-- LEFT: Timeline -->
      <div class="card">
        <h2>Timeline (by month)</h2>
        <div class="muted">
          Scrollable list grouped by <code>period_month</code> (latest first). Filters apply only to this timeline.
        </div>

        <!-- NEW: Status tick-box filters -->
        <div class="filter-row" aria-label="Status filters">
          <label class="filter-chip" title="Show completed">
            <input type="checkbox" class="status-filter" value="completed" checked />
            completed
          </label>
          <label class="filter-chip" title="Show ongoing">
            <input type="checkbox" class="status-filter" value="ongoing" checked />
            ongoing
          </label>
          <label class="filter-chip" title="Show planned">
            <input type="checkbox" class="status-filter" value="planned" checked />
            planned
          </label>
          <label class="filter-chip" title="Show paused">
            <input type="checkbox" class="status-filter" value="paused" checked />
            paused
          </label>

          <span class="filter-spacer"></span>
          <span id="timeline-count">0 shown</span>
        </div>

        <div id="timeline"></div>
      </div>

      <!-- RIGHT: Data quality -->
      <div class="card">
        <h2>Data quality — last org update</h2>
        <div class="muted" style="margin-bottom:10px;">
          Latest <code>last_update</code> per organisation (global). Dot colors: green ≤7d, orange 8–21d, black &gt;21d, grey n/a.
        </div>
        <div id="org-quality" style="
          max-height: 520px;
          overflow:auto;
          border:1px solid #eee;
          border-radius:10px;
          background:#fff;
        "></div>
      </div>
    </div>
  </div>

  <!-- Minimap -->
  <div id="minimap-wrap" title="Click to open the full map">
    <div id="minimap-badge">Benishangul-Gumuz</div>
    <div id="minimap"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  /* =========================
     BASE PATH (GitHub Pages safe)
     ========================= */
  const BASE = window.location.pathname.endsWith('/')
    ? window.location.pathname
    : window.location.pathname.replace(/\/[^\/]*$/, '/');
  const url = (p) => BASE + p.replace(/^\//, '');

  const ETH_ADM1_URL = url('data/eth_admin1.geojson');
  const INTERVENTIONS_URL = url('data/interventions_benishangul_mock.geojson');

  // Hold data once loaded
  let allFeatures = [];

  /* =========================
     Buttons / navigation
     ========================= */
  document.getElementById('btn-open-map').addEventListener('click', () => {
    window.location.href = url('index.html');
  });
  document.getElementById('minimap-wrap').addEventListener('click', () => {
    window.location.href = url('index.html');
  });
  document.getElementById('btn-update').addEventListener('click', () => {
    alert("Update workflow not connected yet.\n\nLater: link this to a Google Form/Sheet or an upload flow.");
  });

  /* =========================
     Helpers
     ========================= */
  function escapeHtml(str) {
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function parseDateLoose(v) {
    if (!v) return null;
    const s = String(v).trim();
    // YYYY-MM-DD or YYYY/MM/DD
    const m = s.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})/);
    if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  // For TIMELINE dot (green/orange/red) — you already use this logic on the map
  function freshnessFromLastUpdate(lastUpdate) {
    const d = parseDateLoose(lastUpdate);
    if (!d) return { color:'#bdbdbd', title:'No last_update', days:null };
    const days = Math.floor((new Date() - d) / (1000*60*60*24));
    if (!isFinite(days) || days < 0) return { color:'#bdbdbd', title:'Invalid last_update', days:null };
    if (days <= 7)  return { color:'#2ca02c', title:`${days} day(s) old`, days };
    if (days <= 21) return { color:'#ff7f0e', title:`${days} day(s) old`, days };
    return { color:'#d62728', title:`${days} day(s) old`, days };
  }

  // For ORG table dot (green/orange/BLACK), per your requirement
  function orgFreshnessFromLastUpdate(lastUpdate) {
    const d = parseDateLoose(lastUpdate);
    if (!d) return { color:'#bdbdbd', title:'No last_update', days:null, dateStr:'n/a' };

    const days = Math.floor((new Date() - d) / (1000*60*60*24));
    if (!isFinite(days) || days < 0) return { color:'#bdbdbd', title:'Invalid last_update', days:null, dateStr:'n/a' };

    if (days <= 7)  return { color:'#2ca02c', title:`${days} day(s) old`, days, dateStr: String(lastUpdate) };
    if (days <= 21) return { color:'#ff7f0e', title:`${days} day(s) old`, days, dateStr: String(lastUpdate) };
    return { color:'#000000', title:`${days} day(s) old`, days, dateStr: String(lastUpdate) }; // noir
  }

  function statusColor(status) {
    const s = String(status || '').toLowerCase();
    if (s === 'planned') return '#808080';
    if (s === 'ongoing') return '#1f77b4';
    if (s === 'completed') return '#2ca02c';
    if (s === 'paused') return '#ff7f0e';
    return '#000000';
  }

  function getSelectedStatuses() {
    const checks = document.querySelectorAll('.status-filter');
    const selected = new Set();
    checks.forEach(cb => { if (cb.checked) selected.add(cb.value); });
    return selected;
  }

  /* =========================
     Timeline render (with status filters)
     ========================= */
  function renderTimeline(features) {
    const el = document.getElementById('timeline');
    const countEl = document.getElementById('timeline-count');
    if (!el) return;

    const selectedStatuses = getSelectedStatuses();

    // filter features for timeline only
    const filtered = features.filter(f => {
      const p = f.properties || {};
      const st = String(p.status || '').toLowerCase();
      // if no checkbox selected => show nothing (intentional)
      return selectedStatuses.has(st);
    });

    if (countEl) countEl.textContent = `${filtered.length} shown`;

    // group by period_month
    const groups = new Map();
    for (const f of filtered) {
      const p = f.properties || {};
      const m = p.period_month || 'n/a';
      if (!groups.has(m)) groups.set(m, []);
      groups.get(m).push(f);
    }

    // sort months desc (YYYY-MM)
    const months = [...groups.keys()].sort().reverse();

    let html = '';
    for (const month of months) {
      const items = groups.get(month);

      // sort inside month: org then woreda then site
      items.sort((a, b) => {
        const pa = a.properties || {}, pb = b.properties || {};
        const oa = String(pa.org_name || ''), ob = String(pb.org_name || '');
        if (oa !== ob) return oa.localeCompare(ob);
        const wa = String(pa.woreda || ''), wb = String(pb.woreda || '');
        if (wa !== wb) return wa.localeCompare(wb);
        const sa = String(pa.site_name || ''), sb = String(pb.site_name || '');
        return sa.localeCompare(sb);
      });

      html += `<div class="month-header">${escapeHtml(month)}</div>`;

      for (const f of items) {
        const p = f.properties || {};
        const org = p.org_name || 'Unknown';
        const woreda = p.woreda || '-';
        const site = p.site_name || '-';
        const status = p.status || '-';

        const fr = freshnessFromLastUpdate(p.last_update);
        const dot = `<span title="${escapeHtml(fr.title)}" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${fr.color};margin-left:6px;vertical-align:middle;"></span>`;
        const badge = `<span style="display:inline-block;padding:2px 8px;border-radius:999px;color:#fff;font-size:12px;line-height:18px;background:${statusColor(status)};white-space:nowrap;">${escapeHtml(String(status).toLowerCase())}</span>`;

        html += `
          <div class="t-item">
            <div class="t-top">
              <div class="t-org">${escapeHtml(org)} ${dot}</div>
              ${badge}
            </div>
            <div class="t-sub">${escapeHtml(woreda)} — ${escapeHtml(site)}</div>
          </div>
        `;
      }
    }

    el.innerHTML = html || `<div style="padding:12px; color:#666;">No data for the selected statuses</div>`;
  }

  /* =========================
     Data quality render (last org update)
     ========================= */
  function renderOrgQuality(features) {
    const el = document.getElementById('org-quality');
    if (!el) return;

    // Aggregate max(last_update) per org
    const byOrg = new Map();

    for (const f of features) {
      const p = f.properties || {};
      const org = p.org_name || 'Unknown';

      const d = parseDateLoose(p.last_update); // Date or null
      if (!byOrg.has(org)) {
        byOrg.set(org, { org, latestDate: null, latestRaw: null, count: 0 });
      }
      const row = byOrg.get(org);
      row.count++;

      if (d && (!row.latestDate || d > row.latestDate)) {
        row.latestDate = d;
        row.latestRaw = p.last_update;
      }
    }

    const rows = [...byOrg.values()];

    // Sort: worst (oldest) first, then name
    rows.sort((a, b) => {
      const fa = orgFreshnessFromLastUpdate(a.latestRaw);
      const fb = orgFreshnessFromLastUpdate(b.latestRaw);

      const da = (fa.days == null) ? 999999 : fa.days;
      const db = (fb.days == null) ? 999999 : fb.days;
      if (db !== da) return db - da; // bigger days first
      return a.org.localeCompare(b.org);
    });

    let html = `
      <div style="display:flex; padding:10px 12px; font-weight:900; background:#f7f7f7; border-bottom:1px solid #eee;">
        <div style="flex:1; min-width:0;">Organisation</div>
        <div style="width:110px; text-align:right;">Last update</div>
      </div>
    `;

    for (const r of rows) {
      const fr = orgFreshnessFromLastUpdate(r.latestRaw);
      const dot = `<span title="${escapeHtml(fr.title)}" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${fr.color};margin-right:8px;vertical-align:middle;"></span>`;
      const dateLabel = r.latestRaw ? escapeHtml(String(r.latestRaw)) : 'n/a';

      html += `
        <div style="display:flex; align-items:center; padding:10px 12px; border-bottom:1px solid #f0f0f0;">
          <div style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${dot}${escapeHtml(r.org)}
            <span style="color:#888; font-weight:600; margin-left:6px;">(${r.count})</span>
          </div>
          <div style="width:110px; text-align:right; font-weight:800; color:#333;">
            ${dateLabel}
          </div>
        </div>
      `;
    }

    el.innerHTML = html || `<div style="padding:12px; color:#666;">No data</div>`;
  }

  /* =========================
     Load interventions once
     ========================= */
  fetch(INTERVENTIONS_URL)
    .then(r => r.json())
    .then(fc => {
      allFeatures = fc.features || [];
      renderTimeline(allFeatures);
      renderOrgQuality(allFeatures);

      // Hook status checkbox changes
      document.querySelectorAll('.status-filter').forEach(cb => {
        cb.addEventListener('change', () => renderTimeline(allFeatures));
      });
    })
    .catch(err => {
      console.error('Interventions load error:', err);
      const t = document.getElementById('timeline');
      if (t) t.innerHTML = `<div style="padding:12px;color:#b00;">Failed to load interventions</div>`;
      const q = document.getElementById('org-quality');
      if (q) q.innerHTML = `<div style="padding:12px;color:#b00;">Failed to load interventions</div>`;
    });

  /* =========================
     MINIMAP (boundaries only)
     ========================= */
  const mm = L.map('minimap', {
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    scrollWheelZoom: false,
    doubleClickZoom: false,
    boxZoom: false,
    keyboard: false,
    tap: false
  }).setView([10.5, 35.7], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mm);

  fetch(ETH_ADM1_URL).then(r => r.json()).then(fc => {
    const ben = (fc.features || []).filter(f => f.properties?.adm1_pcode === 'ET06');
    const layer = L.geoJSON({ type:'FeatureCollection', features: ben }, {
      style: { color:'#ff0000', weight:3, fillOpacity:0 }
    }).addTo(mm);

    mm.fitBounds(layer.getBounds(), { padding:[10,10] });
  }).catch(err => console.error('ADM1 load error:', err));
</script>

</body>
</html>
