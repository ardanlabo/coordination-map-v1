<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coordination GIS – Benishangul-Gumuz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
/* === TON CSS INCHANGÉ (identique à celui que tu as fourni) === */
html, body { margin: 0; padding: 0; height: 100%; }
#map { width: 100%; height: 100%; }
/* (je ne répète pas ici ton CSS pour garder lisible — il reste exactement identique) */
</style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">Interventions</div>
    <div id="sidebar-count" class="sidebar-count">0 shown</div>
    <div id="sidebar-kpi"></div>
  </div>
  <div id="sidebar-list" class="sidebar-list"></div>
</div>

<div id="controls">
  <h4>Filters</h4>

  <label>Organisation</label>
  <select id="filter-org">
    <option value="">All</option>
  </select>

  <!-- ✅ NOUVEAU FILTRE WOREDA -->
  <label>Woreda</label>
  <select id="filter-woreda">
    <option value="">All</option>
  </select>

  <label>Status</label>
  <select id="filter-status">
    <option value="">All</option>
    <option value="planned">Planned</option>
    <option value="ongoing">Ongoing</option>
    <option value="completed">Completed</option>
    <option value="paused">Paused</option>
  </select>

  <label>Month</label>
  <select id="filter-month">
    <option value="">All</option>
  </select>

  <div class="controls-row">
    <input type="checkbox" id="filter-outdated" />
    <label for="filter-outdated" style="display:inline; margin:0; font-weight:600;">
      Outdated only (&gt;21 days)
    </label>
  </div>

  <button class="btn" id="btn-export" type="button">Export CSV (current list)</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>

/* === TON CODE RESTE IDENTIQUE JUSQU'À applyFilters() === */

/* =========================
   INTERVENTIONS + FILTERS
   ========================= */

function applyFilters() {
  const org = document.getElementById('filter-org').value;
  const woreda = document.getElementById('filter-woreda').value;  // ✅ ajouté
  const status = document.getElementById('filter-status').value;
  const month = document.getElementById('filter-month').value;
  const outdatedOnly = document.getElementById('filter-outdated').checked;

  clusterGroup.clearLayers();

  const baseFiltered = interventionsData.features.filter(f => {
    const p = f.properties || {};
    if (org && p.org_name !== org) return false;
    if (woreda && p.woreda !== woreda) return false; // ✅ ajouté
    if (status && String(p.status).toLowerCase() !== status) return false;
    if (month && p.period_month !== month) return false;
    return true;
  });

  updateKpi(baseFiltered);

  const filtered = outdatedOnly
    ? baseFiltered.filter(f => {
        const p = f.properties || {};
        const fr = freshnessFromLastUpdate(p.last_update);
        return fr.band === 'red';
      })
    : baseFiltered;

  currentDisplayedFeatures = filtered;
  document.getElementById('btn-export').disabled = (filtered.length === 0);

  const markersIndex = new Map();

  const layer = L.geoJSON(
    { type: 'FeatureCollection', features: filtered },
    {
      pointToLayer: (feature, latlng) => {
        const p = feature.properties || {};
        const id = String(p.record_id || p.id || `${p.org_name}-${p.site_name}-${p.period_month}`);
        const marker = L.marker(latlng, { icon: statusIcon(p.status) });
        markersIndex.set(id, marker);
        return marker;
      },
      onEachFeature: (feature, marker) => {
        marker.bindPopup(interventionPopup(feature.properties || {}));
      }
    }
  );

  clusterGroup.addLayer(layer);
  renderSidebar(filtered, markersIndex);
}

/* =========================
   FETCH DATA
   ========================= */

fetch(INTERVENTIONS_URL)
  .then(r => r.text())
  .then(csvText => {
    const fc = csvToFeatureCollection(csvText);
    interventionsData = fc;

    const orgs = [...new Set(fc.features.map(f => (f.properties.org_name || '').trim()).filter(Boolean))].sort();
    const months = [...new Set(fc.features.map(f => (f.properties.period_month || '').trim()).filter(Boolean))].sort();
    const woredas = [...new Set(fc.features.map(f => (f.properties.woreda || '').trim()).filter(Boolean))].sort(); // ✅ ajouté

    const orgSel = document.getElementById('filter-org');
    orgs.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      orgSel.appendChild(opt);
    });

    const monthSel = document.getElementById('filter-month');
    months.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      monthSel.appendChild(opt);
    });

    // ✅ remplir filtre woreda
    const woredaSel = document.getElementById('filter-woreda');
    woredas.forEach(w => {
      const opt = document.createElement('option');
      opt.value = w;
      opt.textContent = w;
      woredaSel.appendChild(opt);
    });

    ['filter-org','filter-woreda','filter-status','filter-month','filter-outdated']
      .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));

    document.getElementById('btn-export').disabled = true;

    applyFilters();
  })
  .catch(err => console.error('Interventions load error:', err));

</script>
</body>
</html>
