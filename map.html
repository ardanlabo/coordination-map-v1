<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coordination GIS – Benishangul-Gumuz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100%; }

/* CONTROLS PANEL */
#controls {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:white;
  padding:10px;
  border-radius:6px;
  box-shadow:0 0 6px rgba(0,0,0,0.3);
  width:240px;
  font-size:13px;
}
#controls label { display:block; margin-top:6px; font-weight:600; }
#controls select { width:100%; }
</style>
</head>

<body>

<div id="map"></div>

<div id="controls">
  <h4>Filters</h4>

  <label>Organisation</label>
  <select id="filter-org"><option value="">All</option></select>

  <!-- ✅ NOUVEAU -->
  <label>Woreda</label>
  <select id="filter-woreda"><option value="">All</option></select>

  <label>Status</label>
  <select id="filter-status">
    <option value="">All</option>
    <option value="planned">Planned</option>
    <option value="ongoing">Ongoing</option>
    <option value="completed">Completed</option>
    <option value="paused">Paused</option>
  </select>

  <label>Month</label>
  <select id="filter-month"><option value="">All</option></select>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>

/* =========================
   MAP
   ========================= */
const map = L.map('map').setView([10.5,35.7],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

/* =========================
   DATA
   ========================= */
const INTERVENTIONS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_vGAsaVP8WM3PKX1SEcNSit7Ldh5SjwM9c-F01nmS-mDghFpNHcARtVDOzo1Qc7okT2be-Oi05msp/pub?output=csv";

let interventionsData = null;

const clusterGroup = L.markerClusterGroup({
  showCoverageOnHover:false,
  spiderfyOnMaxZoom:true,
  disableClusteringAtZoom:12
});
map.addLayer(clusterGroup);

/* =========================
   HELPERS
   ========================= */
function parseCSV(text){
  const rows=[]; let row=[]; let cell=''; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch==='"'){
      if(inQuotes && next==='"'){ cell+='"'; i++; }
      else inQuotes=!inQuotes;
    }else if(ch===',' && !inQuotes){
      row.push(cell); cell='';
    }else if((ch==='\n'||ch==='\r') && !inQuotes){
      if(ch==='\r' && next==='\n') i++;
      row.push(cell); rows.push(row); row=[]; cell='';
    }else cell+=ch;
  }
  if(cell.length||row.length){ row.push(cell); rows.push(row); }
  return rows;
}

function csvToObjects(csv){
  const grid=parseCSV(csv).filter(r=>r.some(c=>c.trim()!==''));
  const headers=grid[0].map(h=>h.trim());
  return grid.slice(1).map(r=>{
    const obj={};
    headers.forEach((h,i)=>obj[h]=(r[i]||'').trim());
    return obj;
  });
}

function csvToFeatureCollection(csv){
  const rows=csvToObjects(csv);
  return {
    type:'FeatureCollection',
    features:rows
      .filter(r=>r.latitude && r.longitude)
      .map(r=>({
        type:'Feature',
        geometry:{type:'Point',coordinates:[Number(r.longitude),Number(r.latitude)]},
        properties:r
      }))
  };
}

/* =========================
   FILTERS
   ========================= */
function applyFilters(){
  const org=document.getElementById('filter-org').value;
  const woreda=document.getElementById('filter-woreda').value;
  const status=document.getElementById('filter-status').value;
  const month=document.getElementById('filter-month').value;

  clusterGroup.clearLayers();

  const filtered=interventionsData.features.filter(f=>{
    const p=f.properties||{};
    if(org && p.org_name!==org) return false;
    if(woreda && p.woreda!==woreda) return false;
    if(status && p.status.toLowerCase()!==status) return false;
    if(month && p.period_month!==month) return false;
    return true;
  });

  const layer=L.geoJSON({type:'FeatureCollection',features:filtered});
  clusterGroup.addLayer(layer);
}

/* =========================
   LOAD DATA
   ========================= */
fetch(INTERVENTIONS_URL)
.then(r=>r.text())
.then(csv=>{
  interventionsData=csvToFeatureCollection(csv);

  const orgs=[...new Set(interventionsData.features.map(f=>f.properties.org_name).filter(Boolean))].sort();
  const months=[...new Set(interventionsData.features.map(f=>f.properties.period_month).filter(Boolean))].sort();
  const woredas=[...new Set(interventionsData.features.map(f=>f.properties.woreda).filter(Boolean))].sort();

  orgs.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o; opt.textContent=o;
    document.getElementById('filter-org').appendChild(opt);
  });

  months.forEach(m=>{
    const opt=document.createElement('option');
    opt.value=m; opt.textContent=m;
    document.getElementById('filter-month').appendChild(opt);
  });

  woredas.forEach(w=>{
    const opt=document.createElement('option');
    opt.value=w; opt.textContent=w;
    document.getElementById('filter-woreda').appendChild(opt);
  });

  ['filter-org','filter-woreda','filter-status','filter-month']
    .forEach(id=>document.getElementById(id).addEventListener('change',applyFilters));

  applyFilters();
});

</script>
</body>
</html>
