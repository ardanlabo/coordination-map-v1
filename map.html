<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coordination GIS â€“ Benishangul-Gumuz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100%; }

/* Sidebar */
#sidebar{
  position:absolute; top:10px; left:10px; z-index:1000;
  width:320px; max-height:calc(100% - 20px);
  background:#fff; border-radius:8px;
  box-shadow:0 0 8px rgba(0,0,0,0.25);
  overflow:hidden; font-size:13px;
}
.sidebar-header{
  padding:10px; border-bottom:1px solid #eee;
  display:flex; align-items:baseline;
  justify-content:space-between; gap:10px;
  flex-wrap:wrap;
}
.sidebar-title{ font-weight:800; }
.sidebar-count{ color:#666; }
#sidebar-kpi{
  width:100%; margin-top:6px;
  font-size:12px; color:#555;
  display:flex; gap:10px; flex-wrap:wrap;
}
.kpi-chip{
  display:inline-flex; align-items:center; gap:6px;
  background:#f6f6f6; border:1px solid #eee;
  border-radius:999px; padding:2px 8px;
  line-height:18px;
}
.kpi-dot{ width:8px;height:8px;border-radius:50%; }
.sidebar-list{ overflow:auto; max-height:calc(100% - 74px); }
.item{ padding:10px; border-bottom:1px solid #f0f0f0; cursor:pointer; }
.item:hover{ background:#f8f8f8; }
.item-top{ display:flex; justify-content:space-between; margin-bottom:4px; }
.badge{ padding:2px 8px; border-radius:999px; color:#fff; font-size:12px; }
.item-main{ font-weight:700; }
.item-sub{ color:#666; }

/* Filters */
#controls{
  position:absolute; top:10px; right:10px; z-index:1000;
  background:white; padding:10px;
  border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,0.3);
  width:240px; font-size:13px;
}
#controls label{ display:block; margin-top:6px; font-weight:600; }
#controls select{ width:100%; }
.controls-row{ margin-top:10px; }
.btn{
  width:100%; margin-top:10px;
  padding:8px; border:1px solid #ddd;
  background:#fafafa; border-radius:6px;
  cursor:pointer; font-weight:600;
}
.btn:hover{ background:#f2f2f2; }

.status-pin{
  width:12px;height:12px;border-radius:50%;
  border:2px solid #fff;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">Interventions</div>
    <div id="sidebar-count" class="sidebar-count">0 shown</div>
    <div id="sidebar-kpi"></div>
  </div>
  <div id="sidebar-list" class="sidebar-list"></div>
</div>

<div id="controls">
  <h4>Filters</h4>

  <label>Organisation</label>
  <select id="filter-org"><option value="">All</option></select>

  <label>Woreda</label>
  <select id="filter-woreda"><option value="">All</option></select>

  <label>Status</label>
  <select id="filter-status">
    <option value="">All</option>
    <option value="planned">Planned</option>
    <option value="ongoing">Ongoing</option>
    <option value="completed">Completed</option>
    <option value="paused">Paused</option>
  </select>

  <label>Month</label>
  <select id="filter-month"><option value="">All</option></select>

  <div class="controls-row">
    <input type="checkbox" id="filter-outdated"/>
    <label for="filter-outdated">Outdated only (&gt;21 days)</label>
  </div>

  <button class="btn" id="btn-export">Export CSV</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>

/* =========================
   MAP
   ========================= */
const map = L.map('map').setView([10.5,35.7],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

/* =========================
   DATA SOURCE
   ========================= */
const INTERVENTIONS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_vGAsaVP8WM3PKX1SEcNSit7Ldh5SjwM9c-F01nmS-mDghFpNHcARtVDOzo1Qc7okT2be-Oi05msp/pub?output=csv";

let interventionsData=null;

const clusterGroup=L.markerClusterGroup();
map.addLayer(clusterGroup);

/* =========================
   HELPERS
   ========================= */
function statusColor(s){
  s=String(s||'').toLowerCase();
  if(s==='planned')return'#808080';
  if(s==='ongoing')return'#1f77b4';
  if(s==='completed')return'#2ca02c';
  if(s==='paused')return'#ff7f0e';
  return'#000';
}
function statusIcon(s){
  return L.divIcon({
    className:'',
    html:`<div class="status-pin" style="background:${statusColor(s)}"></div>`,
    iconSize:[12,12], iconAnchor:[6,6]
  });
}

/* =========================
   CSV PARSER
   ========================= */
function parseCSV(t){
  const rows=[]; let row=[],cell='',inQuotes=false;
  for(let i=0;i<t.length;i++){
    const ch=t[i],next=t[i+1];
    if(ch==='"'){
      if(inQuotes&&next==='"'){cell+='"';i++;}
      else inQuotes=!inQuotes;
    }else if(ch===','&&!inQuotes){
      row.push(cell);cell='';
    }else if((ch==='\n'||ch==='\r')&&!inQuotes){
      if(ch==='\r'&&next==='\n')i++;
      row.push(cell);rows.push(row);row=[];cell='';
    }else cell+=ch;
  }
  if(cell||row.length){row.push(cell);rows.push(row);}
  return rows;
}
function csvToFeatureCollection(csv){
  const grid=parseCSV(csv).filter(r=>r.some(c=>c.trim()!==''));
  const headers=grid[0].map(h=>h.trim());
  const features=[];
  grid.slice(1).forEach(r=>{
    const obj={};
    headers.forEach((h,i)=>obj[h]=(r[i]||'').trim());
    if(obj.latitude&&obj.longitude){
      features.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[+obj.longitude,+obj.latitude]},
        properties:obj
      });
    }
  });
  return {type:'FeatureCollection',features};
}

/* =========================
   FILTERS
   ========================= */
function applyFilters(){
  const org=document.getElementById('filter-org').value;
  const woreda=document.getElementById('filter-woreda').value;
  const status=document.getElementById('filter-status').value;
  const month=document.getElementById('filter-month').value;
  const outdated=document.getElementById('filter-outdated').checked;

  clusterGroup.clearLayers();

  const filtered=interventionsData.features.filter(f=>{
    const p=f.properties;
    if(org&&p.org_name!==org)return false;
    if(woreda&&p.woreda!==woreda)return false;
    if(status&&p.status.toLowerCase()!==status)return false;
    if(month&&p.period_month!==month)return false;
    if(outdated&&p.last_update){
      const days=(Date.now()-new Date(p.last_update))/86400000;
      if(days<=21)return false;
    }
    return true;
  });

  const layer=L.geoJSON({type:'FeatureCollection',features:filtered},{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:statusIcon(f.properties.status)})
  });
  clusterGroup.addLayer(layer);

  document.getElementById('sidebar-count').textContent=filtered.length+' shown';
}

/* =========================
   LOAD DATA
   ========================= */
fetch(INTERVENTIONS_URL)
.then(r=>r.text())
.then(csv=>{
  interventionsData=csvToFeatureCollection(csv);

  const orgs=[...new Set(interventionsData.features.map(f=>f.properties.org_name).filter(Boolean))].sort();
  const months=[...new Set(interventionsData.features.map(f=>f.properties.period_month).filter(Boolean))].sort();
  const woredas=[...new Set(interventionsData.features.map(f=>f.properties.woreda).filter(Boolean))].sort();

  orgs.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o; opt.textContent=o;
    document.getElementById('filter-org').appendChild(opt);
  });
  months.forEach(m=>{
    const opt=document.createElement('option');
    opt.value=m; opt.textContent=m;
    document.getElementById('filter-month').appendChild(opt);
  });
  woredas.forEach(w=>{
    const opt=document.createElement('option');
    opt.value=w; opt.textContent=w;
    document.getElementById('filter-woreda').appendChild(opt);
  });

  ['filter-org','filter-woreda','filter-status','filter-month','filter-outdated']
    .forEach(id=>document.getElementById(id).addEventListener('change',applyFilters));

  applyFilters();
})
.catch(e=>console.error(e));

</script>
</body>
</html>
