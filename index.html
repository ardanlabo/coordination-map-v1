<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coordination Dashboard — Benishangul-Gumuz (Nutrition)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#111;
  --muted:#666;
  --border:#e7e7ea;

  --green:#2ca02c;
  --orange:#ff7f0e;
  --red:#d62728;
  --grey:#bdbdbd;

  --shadow: 0 10px 22px rgba(0,0,0,0.07);
  --radius:14px;
}

html,body{
  margin:0;
  background:var(--bg);
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
}

.topbar{
  height:56px;
  background:#fff;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 18px;
}

.topbar h1{
  font-size:15px;
  font-weight:900;
  margin:0;
}

.actions{ display:flex; gap:10px; }

.btn{
  border:1px solid var(--border);
  padding:7px 10px;
  border-radius:10px;
  font-weight:900;
  font-size:13px;
  text-decoration:none;
  color:inherit;
  background:#fff;
}

.wrap{
  max-width:1500px;
  margin:0 auto;
  padding:18px;
}

.grid{
  display:grid;
  grid-template-columns: 1.25fr 0.95fr 0.65fr;
  gap:14px;
}

@media(max-width:1280px){
  .grid{ grid-template-columns:1fr 1fr; }
  .grid > :nth-child(3){ grid-column:1/-1; }
}

@media(max-width:820px){
  .grid{ grid-template-columns:1fr; }
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
}

.card .hd{
  padding:14px;
  border-bottom:1px solid var(--border);
}

.card .hd .title{
  font-weight:900;
  font-size:14px;
  margin-bottom:4px;
}

.card .bd{ padding:14px; }

.scroll{ max-height:52vh; overflow:auto; }

.pill{
  font-size:11px;
  font-weight:900;
  padding:2px 8px;
  border-radius:999px;
  color:#fff;
}

.pill.planned{background:#808080;}
.pill.ongoing{background:#1f77b4;}
.pill.completed{background:#2ca02c;}
.pill.paused{background:#ff7f0e;}

.wRow{ cursor:pointer; }
.wRow:hover{ background:#fafafa; }

.miniMapBox{ position:relative; margin:14px; }
.miniMapFrame{ width:100%; height:220px; border:0; }
.miniMapOverlay{ position:absolute; inset:0; cursor:pointer; }
.miniMapHint{
  position:absolute;
  bottom:10px; right:10px;
  background:#fff;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid var(--border);
}

.dot{ width:10px;height:10px;border-radius:50%;display:inline-block; }
.dot.g{background:var(--green);}
.dot.o{background:var(--orange);}
.dot.r{background:var(--red);}
.dot.n{background:var(--grey);}
</style>
</head>

<body>

<div class="topbar">
  <h1>Coordination Dashboard — Benishangul-Gumuz</h1>
  <div class="actions">
    <a class="btn" href="./map.html" target="_blank">Open full map</a>
  </div>
</div>

<div class="wrap">
<div class="grid">

<!-- LEFT -->
<div class="card">
  <div class="hd">
    <div class="title">Woreda Coverage</div>
  </div>
  <div class="bd">
    <select id="w-month"><option value="">All months</option></select>
    <div class="scroll">
      <table width="100%">
        <thead>
          <tr><th>Woreda</th><th align="right">#</th></tr>
        </thead>
        <tbody id="woreda-body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MIDDLE -->
<div class="card">
  <div class="hd">
    <div class="title">Data Quality</div>
  </div>
  <div class="bd">
    <div style="width:160px;height:160px;">
      <canvas id="dq-donut"></canvas>
    </div>
    <div id="dq-body"></div>
  </div>
</div>

<!-- RIGHT -->
<div class="card">
  <div class="hd">
    <div class="title">Map Preview</div>
  </div>
  <div class="bd" style="padding:0;">
    <div class="miniMapBox">
      <iframe class="miniMapFrame" src="./map.html"></iframe>
      <a class="miniMapOverlay" href="./map.html" target="_blank"></a>
      <div class="miniMapHint">Click to open full map</div>
    </div>
  </div>
</div>

</div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_vGAsaVP8WM3PKX1SEcNSit7Ldh5SjwM9c-F01nmS-mDghFpNHcARtVDOzo1Qc7okT2be-Oi05msp/pub?output=csv";

function parseCSV(text){
  const rows=[];let row=[],cell="",inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'){ if(inQ&&n=='"'){cell+='"';i++;} else inQ=!inQ;}
    else if(c==','&&!inQ){row.push(cell);cell="";}
    else if((c=='\n'||c=='\r')&&!inQ){row.push(cell);rows.push(row);row=[];cell="";}
    else cell+=c;
  }
  return rows;
}

function freshness(d){
  const date=new Date(d);
  if(isNaN(date)) return 'na';
  let days=Math.floor((Date.now()-date)/86400000);
  if(days<0) days=0;
  if(days<=7) return 'green';
  if(days<=21) return 'orange';
  return 'red';
}

fetch(CSV_URL).then(r=>r.text()).then(t=>{
  const grid=parseCSV(t);
  const headers=grid[0];
  const data=grid.slice(1).map(r=>{
    let o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;
  });

  // Populate months
  const months=[...new Set(data.map(d=>d.period_month))];
  const sel=document.getElementById("w-month");
  months.forEach(m=>{
    const opt=document.createElement("option");
    opt.value=m; opt.textContent=m;
    sel.appendChild(opt);
  });

  function render(){
    const month=sel.value;
    const filtered=month?data.filter(d=>d.period_month==month):data;

    const map={};
    filtered.forEach(d=>{
      map[d.woreda]=(map[d.woreda]||0)+1;
    });

    const body=document.getElementById("woreda-body");
    body.innerHTML="";
    Object.entries(map).sort((a,b)=>b[1]-a[1]).forEach(([w,n])=>{
      const tr=document.createElement("tr");
      tr.className="wRow";
      tr.innerHTML=`<td>${w}</td><td align="right">${n}</td>`;
      body.appendChild(tr);
    });

    // Data quality
    const orgLatest={};
    data.forEach(d=>{
      if(!orgLatest[d.org_name]|| new Date(d.last_update)>new Date(orgLatest[d.org_name])){
        orgLatest[d.org_name]=d.last_update;
      }
    });

    const bands={green:0,orange:0,red:0,na:0};
    Object.values(orgLatest).forEach(d=>{
      bands[freshness(d)]++;
    });

    new Chart(document.getElementById("dq-donut"),{
      type:'doughnut',
      data:{
        labels:["≤7d","8–21d",">21d","n/a"],
        datasets:[{
          data:[bands.green,bands.orange,bands.red,bands.na],
          backgroundColor:["#2ca02c","#ff7f0e","#d62728","#bdbdbd"]
        }]
      },
      options:{cutout:"70%",plugins:{legend:{display:false}}}
    });
  }

  sel.addEventListener("change",render);
  render();
});
</script>

</body>
</html>
